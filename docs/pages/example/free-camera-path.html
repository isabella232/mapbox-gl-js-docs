<div id="map"></div>

<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
<script>
    // we need to save route coordinates later
    var route = null;
    var map = new mapboxgl.Map({
        container: 'map',
        zoom: 11.53,
        center: [6.5615, 46.0598],
        pitch: 65,
        bearing: -180,
        style: 'mapbox://styles/mapbox/satellite-v9',
        hash: true,
        interactive: false
    });

    // add terrain, sky and line layers once the style has loaded
    map.on('load', function () {
        map.addSource('mapbox-dem', {
            'type': 'raster-dem',
            'url': 'mapbox://mapbox.terrain-rgb',
            'tileSize': 512,
            'maxzoom': 14
        });
        map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

        map.addLayer({
            'id': 'sky',
            'type': 'sky',
            'paint': {
                'sky-type': 'atmosphere',
                'sky-atmosphere-sun': [0.0, 90.0],
                'sky-atmosphere-sun-intensity': 15
            }
        });

        route = [
            [6.56158447265625, 46.059891147620725],
            [6.591796875, 46.04750160330395],
            [6.604156494140625, 46.04559527286162],
            [6.623382568359375, 46.00936249465674],
            [6.62750244140625, 45.97406038956237],
            [6.62750244140625, 45.96642454131025],
            [6.639862060546875, 45.94255573048781],
            [6.637115478515625, 45.930139885994556],
            [6.642608642578125, 45.909122123907295],
            [6.642608642578125, 45.88522863923791],
            [6.6192626953125, 45.86132487333675],
            [6.618919372558594, 45.861563961888706],
            [6.6082763671875, 45.855347325388166],
            [6.603126525878906, 45.849847413733556],
            [6.59351348876953, 45.84506443975059],
            [6.588706970214844, 45.840520233530974],
            [6.599349975585937, 45.83143070758022],
            [6.604499816894531, 45.82281820819514],
            [6.6268157958984375, 45.80846108136044],
            [6.619606018066406, 45.799126963971986],
            [6.611022949218749, 45.794100252988855],
            [6.599006652832031, 45.782608925150114],
            [6.5897369384765625, 45.77111522826842],
            [6.550254821777344, 45.762493400907125],
            [6.5375518798828125, 45.75842151920504],
            [6.540641784667969, 45.75602615586017],
            [6.550254821777344, 45.75578661387029],
            [6.561241149902344, 45.751953802189036],
            [6.568107604980469, 45.74931859146163],
            [6.580467224121094, 45.749558161214516],
            [6.5856170654296875, 45.74883944887109],
            [6.590766906738281, 45.75363068968973],
            [6.590766906738281, 45.749558161214516],
            [6.587677001953124, 45.74500616007653],
            [6.583900451660156, 45.74237062133277],
            [6.578407287597655, 45.73805765319192],
            [6.5760040283203125, 45.73470289208261],
            [6.573600769042969, 45.732546153514406],
            [6.573600769042969, 45.72679444346731],
            [6.577720642089844, 45.72655477602849],
            [6.578407287597655, 45.72343900575002],
            [6.5814971923828125, 45.71936427471123],
            [6.576690673828125, 45.716967235281096],
            [6.5787506103515625, 45.71385093029221],
            [6.571197509765625, 45.71025497782458],
            [6.5705108642578125, 45.70258283927926],
            [6.567420959472656, 45.69850658738846],
            [6.568107604980469, 45.69227174496596],
            [6.56982421875, 45.686276048625025],
            [6.572914123535156, 45.6841174406096],
            [6.5863037109375, 45.688194741379654],
            [6.590766906738281, 45.68915406307737],
            [6.5966033935546875, 45.68915406307737],
            [6.60003662109375, 45.68915406307737],
            [6.604499816894531, 45.686755727983574],
            [6.609306335449219, 45.685316677568025],
            [6.61376953125, 45.6833978860947],
            [6.614799499511719, 45.682198608003404],
            [6.6172027587890625, 45.68507683223297],
            [6.62750244140625, 45.689393890931],
            [6.632995605468749, 45.69419023205748],
            [6.641578674316406, 45.69970551585262],
            [6.646385192871094, 45.69970551585262],
            [6.649818420410156, 45.70018508004011],
            [6.655311584472656, 45.69874637513791],
            [6.655998229980469, 45.69610865333701],
            [6.65393829345703, 45.69251155945152],
            [6.658058166503906, 45.69299118533764],
            [6.661491394042969, 45.69538925306953],
            [6.664924621582031, 45.69443003831652],
            [6.669731140136719, 45.69275137290873],
            [6.675224304199219, 45.6913124767407],
            [6.681060791015625, 45.69395042477016],
            [6.679344177246094, 45.69083283645816],
            [6.683464050292969, 45.69155229533948],
            [6.686038970947265, 45.69047310354692],
            [6.688957214355468, 45.69095274691439],
            [6.692218780517578, 45.6913124767407],
            [6.694278717041016, 45.693710616454496],
            [6.696510314941406, 45.69359071191104],
            [6.6996002197265625, 45.69287127925172],
            [6.701831817626953, 45.6919120213096],
            [6.705608367919922, 45.69347080711052],
            [6.711444854736327, 45.69359071191104],
            [6.715908050537109, 45.694669843547246],
            [6.715908050537109, 45.695868854276156],
            [6.7172813415527335, 45.695868854276156],
            [6.720199584960937, 45.697067839297304],
            [6.722087860107422, 45.69766732216748],
            [6.724491119384766, 45.69826679861071],
            [6.724491119384766, 45.696947941952025],
            [6.7229461669921875, 45.69634845136956],
            [6.726036071777343, 45.69646835000021],
            [6.726036071777343, 45.695269352125166],
            [6.723804473876953, 45.69538925306953],
            [6.722259521484375, 45.69502954946522],
            [6.723976135253906, 45.69407032854236],
            [6.727924346923828, 45.69359071191104],
            [6.731700897216797, 45.69347080711052],
            [6.733589172363281, 45.685796365153145],
            [6.736164093017578, 45.685316677568025],
            [6.737709045410155, 45.68315803253308],
            [6.7406272888183585, 45.68135909804323],
            [6.741142272949218, 45.67991990880423],
            [6.744403839111328, 45.677521177806625],
            [6.747150421142578, 45.67632177374556],
            [6.749382019042968, 45.675602118969],
            [6.7510986328125, 45.673922888498886],
            [6.75333023071289, 45.673922888498886],
            [6.757106781005859, 45.67212365707973],
            [6.757793426513672, 45.670804183942856],
            [6.758823394775391, 45.66972459187521],
            [6.760196685791016, 45.67116404333791],
            [6.7668914794921875, 45.67104409046331],
            [6.769123077392578, 45.67092413733162],
            [6.769809722900391, 45.670684230297006],
            [6.771183013916016, 45.67044432223406],
            [6.774959564208984, 45.66996450302317],
            [6.771183013916016, 45.66996450302317],
            [6.774272918701171, 45.66924476649434],
            [6.772041320800781, 45.66924476649434],
            [6.776332855224609, 45.66864497898383],
            [6.771697998046875, 45.66804518504624],
            [6.7751312255859375, 45.66804518504624],
            [6.772041320800781, 45.6672054627361],
            [6.774272918701171, 45.66684557788979],
            [6.775989532470703, 45.66636572782888],
            [6.774616241455078, 45.66576590946832],
            [6.777534484863281, 45.66420635165205],
            [6.78131103515625, 45.66120707989019],
            [6.782684326171875, 45.65880754679246],
            [6.7859458923339835, 45.6552080543316],
            [6.787662506103516, 45.650888357959964],
            [6.786632537841797, 45.648368381209906],
            [6.7859458923339835, 45.645728283964466],
            [6.7859458923339835, 45.64260800861499],
            [6.7847442626953125, 45.64008765934397],
            [6.7847442626953125, 45.63696706983158],
            [6.785430908203125, 45.63504662067249],
            [6.784572601318359, 45.632045787102584],
            [6.784229278564453, 45.62988508743802],
            [6.782684326171875, 45.62880470636917],
            [6.780452728271484, 45.62760425853561],
            [6.778221130371094, 45.625563438215984],
            [6.778564453125, 45.62376265270239],
            [6.781826019287109, 45.62280221010927],
            [6.785087585449219, 45.62628373622459],
            [6.787834167480469, 45.62628373622459],
            [6.795730590820312, 45.62460302647399],
            [6.798305511474609, 45.62316237800989],
            [6.804313659667969, 45.620040846000514],
            [6.809806823730468, 45.61811981684217],
            [6.81976318359375, 45.61619872186784],
            [6.826972961425781, 45.612596491395976],
            [6.830406188964844, 45.60851368380873],
            [6.837272644042969, 45.60587170876381],
            [6.844139099121094, 45.60491095971415],
            [6.854438781738281, 45.600347177025895],
            [6.860961914062499, 45.596743928454124],
            [6.87366485595703, 45.59121849790357],
            [6.8808746337890625, 45.58425087527738],
            [6.8849945068359375, 45.58881596710952],
            [6.8849945068359375, 45.58064659316782],
            [6.881904602050781, 45.577763000878925],
            [6.8877410888671875, 45.569832358492825],
            [6.892890930175781, 45.56117947133065],
            [6.898384094238281, 45.558294879426235],
            [6.900787353515625, 45.55468893129084],
            [6.901817321777344, 45.55012106480582],
            [6.906280517578124, 45.54747634083502],
            [6.909027099609375, 45.5414651417455],
            [6.912117004394531, 45.536415237778485],
            [6.9138336181640625, 45.53617475484822],
            [6.916580200195312, 45.532086387683606],
            [6.913146972656249, 45.5277572043752],
            [6.913146972656249, 45.52246552781801],
            [6.915550231933593, 45.518135604031734],
            [6.9152069091796875, 45.515248803053986],
            [6.918296813964844, 45.51067773196122],
            [6.919841766357422, 45.508632658903785],
            [6.920356750488281, 45.50694842529826],
            [6.922416687011718, 45.50370011817536],
            [6.920528411865234, 45.5043016706727],
            [6.920528411865234, 45.50370011817536],
            [6.922760009765625, 45.50189542211625],
            [6.922760009765625, 45.50069225927091],
            [6.9179534912109375, 45.50261730748197],
            [6.922588348388672, 45.49924842991741],
            [6.9234466552734375, 45.498887466793974],
            [6.923103332519531, 45.49792488715174],
            [6.92584991455078, 45.495277708287695],
            [6.9268798828125, 45.49503704949293],
            [6.926708221435547, 45.49238973487207],
            [6.925163269042969, 45.49299140821332],
            [6.928596496582031, 45.48577090387727],
            [6.926708221435547, 45.48312315370178],
            [6.924304962158203, 45.48095672008698],
            [6.924476623535156, 45.47939202177826],
            [6.923103332519531, 45.4781883781261],
            [6.919841766357422, 45.47722544469191],
            [6.9179534912109375, 45.4766236029392],
            [6.917781829833984, 45.47614212490894],
            [6.915035247802734, 45.475781013686465],
            [6.911430358886719, 45.47325317033553],
            [6.909198760986328, 45.4710863572147],
            [6.907310485839843, 45.469039846107734]
        ];
        map.addSource('trace', {
            type: 'geojson',
            data: {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': route
                }
            }
        });
        map.addLayer({
            type: 'line',
            source: 'trace',
            id: 'line',
            paint: {
                'line-color': 'orange',
                'line-width': 5
            },
            layout: {
                'line-cap': 'round',
                'line-join': 'round'
            }
        });
    });

    // wait for the terrain and sky to load before starting animation
    map.on('idle', function () {
        // linearly interpolate between two altitudes/position based on time
        var lerp = (a, b, t) => {
            if (Array.isArray(a) && Array.isArray(b)) {
                var result = [];
                for (var i = 0; i < Math.min(a.length, b.length); i++)
                    result[i] = a[i] * (1.0 - t) + b[i] * t;
                return result;
            } else {
                return a * (1.0 - t) + b * t;
            }
        };

        var animationTime = 0.0;
        var routeIndex = 0;
        // set up a route for the camera to follow
        // this is separate from the route added above that the camera will focus on
        var cameraPositionRoute = [
            [6.5608978271484375, 46.060129380848586],
            [6.598663330078125, 46.065132041186985],
            [6.622695922851562, 46.05941467808127],
            [6.644668579101562, 46.0498844238435],
            [6.671447753906249, 46.02986553649432],
            [6.6844940185546875, 46.00697792659972],
            [6.6872406005859375, 45.98169518512228],
            [6.6913604736328125, 45.947330315089275],
            [6.683807373046875, 45.922975634260695],
            [6.6652679443359375, 45.8981323978714],
            [6.6323089599609375, 45.88140472759939],
            [6.6062164306640625, 45.867540841540254],
            [6.5093994140625, 45.817315080406246],
            [6.512145996093749, 45.77901739936284],
            [6.512145996093749, 45.7387765043515],
            [6.53411865234375, 45.7176863579072],
            [6.56707763671875, 45.68315803253308],
            [6.62200927734375, 45.6658858736546],
            [6.68243408203125, 45.66780526567164],
            [6.72637939453125, 45.66972459187521],
            [6.77581787109375, 45.67740123855739],
            [6.822509765624999, 45.67548217560647],
            [6.85821533203125, 45.64668833372338],
            [6.8939208984375, 45.63516665067313],
            [6.92962646484375, 45.596743928454124],
            [6.94610595703125, 45.569832358492825],
            [6.94610595703125, 45.52559248776561],
            [6.943359374999999, 45.50249699389715],
            [6.92962646484375, 45.48516915340121],
            [6.90765380859375, 45.46783598133375]
        ];
        var duration = 20000 / route.length;
        var frameRate = 1000.0 / 60.0; // ~16 ms
        var currentRoutePosition = null;
        var currentCameraPosition = null;
        var camera = map.getFreeCameraOptions();

        setInterval(() => {
            // get start and end positions for the route and camera for this section of the animation
            var routePosition = {
                start: currentRoutePosition || route[routeIndex],
                end: route[routeIndex + 1]
            };
            var cameraPosition = {
                start: currentCameraPosition || cameraPositionRoute[routeIndex],
                end: cameraPositionRoute[routeIndex + 1]
            };

            // create a LineString with Turf.js to allow us to interpolate between points
            var routeLineSegment = turf.lineString([
                routePosition.start,
                routePosition.end
            ]);
            var cameraLineSegment = turf.lineString([
                cameraPosition.start,
                cameraPosition.end
            ]);

            // calculate the distance between the start and end points for this section of the animation
            var routeCoordinates = routeLineSegment.geometry.coordinates;
            var routeLineSegmentDistance = turf.distance(
                routeCoordinates[0],
                routeCoordinates[1]
            );

            var cameraCoordinates = cameraLineSegment.geometry.coordinates;
            var cameraLineSegmentDistance = turf.distance(
                cameraCoordinates[0],
                cameraCoordinates[1]
            );

            // determine how far through the animation we are as a percentage of the duration
            var phase = animationTime / duration;

            // calculate a point x% along a line from the start and end points
            // the percent is determined by the phase calculation above
            var alongRoute = turf.along(
                routeLineSegment,
                routeLineSegmentDistance * phase
            );
            var alongCamera = turf.along(
                cameraLineSegment,
                cameraLineSegmentDistance * phase
            );

            currentRoutePosition = alongRoute.geometry.coordinates;
            currentCameraPosition = alongCamera.geometry.coordinates;

            // interpolate camera position while keeping focus on the target lat/lng
            var position = lerp(
                cameraPosition.start,
                cameraPosition.end,
                phase
            );
            var target = lerp(routePosition.start, routePosition.end, phase);

            camera.position = mapboxgl.MercatorCoordinate.fromLngLat(
                position,
                7000
            );
            camera.lookAtPoint(target);

            map.setFreeCameraOptions(camera);

            animationTime += frameRate;

            if (animationTime > duration) {
                currentRoutePosition = null;
                currentCameraPosition = null;

                if (routeIndex < route.length) {
                    routeIndex++;
                } else {
                    routeIndex = 0;
                }

                animationTime = 0.0;
            }
        }, frameRate);
    });
</script>
